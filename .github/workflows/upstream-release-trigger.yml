name: Upstream Release Trigger

# This workflow can be triggered by repository dispatch events
# You can set up webhooks from CRI-O and Kubernetes repos to trigger this
on:
  repository_dispatch:
    types: [crio-release, kubernetes-release, upstream-release]
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: 'Which upstream repo released (cri-o or kubernetes)'
        required: true
        type: choice
        options:
        - cri-o
        - kubernetes
        - both
      version:
        description: 'Version that was released (optional - will auto-detect if empty)'
        required: false
        type: string

jobs:
  trigger-auto-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Parse repository dispatch
      if: github.event_name == 'repository_dispatch'
      run: |
        echo "Repository dispatch triggered by: ${{ github.event.action }}"
        echo "Client payload: ${{ toJson(github.event.client_payload) }}"
        
        # Extract information from webhook payload
        UPSTREAM_REPO="${{ github.event.action }}"
        VERSION="${{ github.event.client_payload.version || github.event.client_payload.tag_name }}"
        
        echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Parse manual dispatch
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "Manual dispatch triggered"
        UPSTREAM_REPO="${{ github.event.inputs.upstream_repo }}"
        VERSION="${{ github.event.inputs.version }}"
        
        echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Validate upstream release
      run: |
        echo "Upstream repo: $UPSTREAM_REPO"
        echo "Version: $VERSION"
        
        # Validate the release exists
        if [ "$UPSTREAM_REPO" = "cri-o" ] || [ "$UPSTREAM_REPO" = "both" ]; then
          if [ -n "$VERSION" ]; then
            echo "Validating CRI-O release $VERSION"
            curl -f -s "https://api.github.com/repos/cri-o/cri-o/releases/tags/$VERSION" > /dev/null
            echo "âœ… CRI-O release $VERSION validated"
          fi
        fi
        
        if [ "$UPSTREAM_REPO" = "kubernetes" ] || [ "$UPSTREAM_REPO" = "both" ]; then
          if [ -n "$VERSION" ]; then
            echo "Validating Kubernetes release $VERSION"
            curl -f -s "https://api.github.com/repos/kubernetes/kubernetes/releases/tags/$VERSION" > /dev/null
            echo "âœ… Kubernetes release $VERSION validated"
          fi
        fi

    - name: Trigger auto-release workflow
      uses: actions/github-script@v7
      with:
        script: |
          const result = await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'auto-release.yml',
            ref: 'main',
            inputs: {
              force_release: 'true'
            }
          });
          
          console.log('Triggered auto-release workflow:', result.status);

    - name: Create issue for manual review
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Upstream release trigger failed: ${process.env.UPSTREAM_REPO} ${process.env.VERSION}`,
            body: `
          ## Upstream Release Trigger Failed
          
          **Upstream Repository:** ${process.env.UPSTREAM_REPO}
          **Version:** ${process.env.VERSION || 'auto-detect'}
          **Trigger Type:** ${context.eventName}
          **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
          
          ### Possible Issues
          - [ ] Version validation failed (release doesn't exist)
          - [ ] Network connectivity issues
          - [ ] API rate limiting
          - [ ] Workflow dispatch permissions
          
          ### Manual Steps
          1. Verify the upstream release exists
          2. Check workflow permissions
          3. Manually trigger auto-release workflow if needed
          
          ### Auto-generated
          This issue was automatically created by the upstream-release-trigger workflow.
          `,
            labels: ['automation', 'upstream-release', 'needs-review']
          });
          
          console.log('Created issue:', issue.data.number);